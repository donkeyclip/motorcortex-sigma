const Helper = require('../../_coreUtils/Helper');
const helper = new Helper();
const Clip = require('./SCGroup');
const Channel = require('./SCIChannel');

function ClipFromDefinition(definition, clipClass=null){
    if(definition === null){
        helper.error(`ClipFromDefinition expects the defintion parameter`);
        return false;
    }
    
    if(clipClass === null){
        clipClass = Clip;
    }
    
    let clip = new clipClass(definition.attrs, definition.props);
    clip.plugin_channel_class = Channel;
    clip.mc_plugin_npm_name = "@kissmybutton/self-contained-incidents";
    constructIncidents(clip, definition);
    
    return clip;
}
    
function constructIncidents(parentIncident, incidentDefinition){
    if(parentIncident.hasIncidents){
        for(let i=0; i<incidentDefinition.incidents.length; i++){
            const incidentItem = incidentDefinition.incidents[i];
            // incidentItem is an object:
            /*
            {
                id
                millisecond
                incident
            }
            */
            
            const theNewIncident = new incidentItem.incident.Incident(incidentItem.incident.attrs, incidentItem.incident.props);
            theNewIncident.plugin_channel_class = incidentItem.incident.plugin_channel_class;
            theNewIncident.mc_plugin_npm_name = incidentItem.incident.mc_plugin_npm_name;
            parentIncident.addIncident(theNewIncident, incidentItem.millisecond);
            constructIncidents(theNewIncident, incidentItem.incident);
        }
    }
}
    

module.exports = ClipFromDefinition;