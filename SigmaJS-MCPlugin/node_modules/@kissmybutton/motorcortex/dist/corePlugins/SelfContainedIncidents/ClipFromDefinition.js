'use strict';

var Helper = require('../../_coreUtils/Helper');
var helper = new Helper();
var Clip = require('./SCGroup');
var Channel = require('./SCIChannel');

function ClipFromDefinition(definition) {
    var clipClass = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;

    if (definition === null) {
        helper.error('ClipFromDefinition expects the defintion parameter');
        return false;
    }

    if (clipClass === null) {
        clipClass = Clip;
    }

    var clip = new clipClass(definition.attrs, definition.props);
    clip.plugin_channel_class = Channel;
    clip.mc_plugin_npm_name = "@kissmybutton/self-contained-incidents";
    constructIncidents(clip, definition);

    return clip;
}

function constructIncidents(parentIncident, incidentDefinition) {
    if (parentIncident.hasIncidents) {
        for (var i = 0; i < incidentDefinition.incidents.length; i++) {
            var incidentItem = incidentDefinition.incidents[i];
            // incidentItem is an object:
            /*
            {
                id
                millisecond
                incident
            }
            */

            var theNewIncident = new incidentItem.incident.Incident(incidentItem.incident.attrs, incidentItem.incident.props);
            theNewIncident.plugin_channel_class = incidentItem.incident.plugin_channel_class;
            theNewIncident.mc_plugin_npm_name = incidentItem.incident.mc_plugin_npm_name;
            parentIncident.addIncident(theNewIncident, incidentItem.millisecond);
            constructIncidents(theNewIncident, incidentItem.incident);
        }
    }
}

module.exports = ClipFromDefinition;